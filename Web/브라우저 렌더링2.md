## 최신 브라우저의 렌더링 과정 (크롬 기준)

![image](https://user-images.githubusercontent.com/62097867/215323544-852baac7-aad3-47ff-94a1-32a2f4eccd86.png)

### Update Layer Tree

렌더링에 사용될 최종 layer들을 계산해서 생성하는 과정

![image](https://user-images.githubusercontent.com/62097867/215323698-acfdb000-9d65-402c-94ec-64cb1df0f353.png)

- Browser internal layers

  - z-index가 같은 레이어들이 있는 경우 별도로 layer를 만들어서 처리한다.
  - scrollbar가 있는 경우 등등

- Render Layer(Paint Layer) 중에서 특정 조건을 만족하면 Graphics Layer를 생성한다.

### Composite

![image](https://user-images.githubusercontent.com/62097867/215324344-76b869c6-1689-4a6b-960a-1c1f04be52eb.png)

Tiled Backing Store 기법이란 비트맵을 하나로 그리지 않고 타일로 나눠서 그리는 것으로 이를 통해 화면을 재사용할 수 있다.

![image](https://user-images.githubusercontent.com/62097867/215345205-0f8bc3fa-f371-4a82-88b5-d3a846633994.png)

paint 과정은 굉장히 비용이 큰 작업이기 때문에 layer 단위로 분리하여 처리하면 변화하는 레이어만 다시 그리면 되므로 paint 비용을 줄일 수 있다!

## 스레드 분리

브라우저의 모든 자료구조들은 메인 스레드에서만 동작을 해야한다.
HTML과 JS는 병렬로 처리할 수 없는 구조이기 때문이다.

### Main Thread

- 파싱에서 paint까지의 과정을 처리하는 스레드
- 렌더링 처리와 자바스크립트 실행 처리를

### Compositor Thread

- 레이어들의 합성을 처리하는 스레드
- 레이어들의 개수, z-index 정보, 좌표 정보 정도만 복사해오면 된다.
- 스크롤링, 애니메이션, pinch zoom 등등 을 compositor 스레드에서 처리할 수 있게 되었다.

| 전 | 후 |
| --- | --- |
| <img src="https://user-images.githubusercontent.com/62097867/215325333-5fc67415-cc70-44b6-91eb-e741e750e672.png" /> | <img src="https://user-images.githubusercontent.com/62097867/215325362-56697a01-12d1-4dd4-92cc-3a98250a2a88.png" /> |

### Raster Thread

![image](https://user-images.githubusercontent.com/62097867/215325542-621a5ec6-dd85-49f4-9b6f-ad21f5dce9ed.png)

- paint 해야할 레이어들을 픽셀로 변환(래스터화)하는 과정
- 메인 스레드에서 저장해둔 그래픽 커맨드 집합(PaintRecords)을 실행

## 동작 과정

![image](https://user-images.githubusercontent.com/62097867/215329200-b273137d-3cc1-4ccf-9a00-f0a42bb10b1b.png)

![image](https://user-images.githubusercontent.com/62097867/215326064-0b4ea8a9-2b9c-4281-99e1-657498981e82.png)

1. 메인 스레드에서의 페인트 과정은 각 레이어에서 실행할 그래픽 커맨드를 저장(record)해둔다.
2. 컴포지터 스레드로 record가 넘어가게 되고 레이어를 타일 형태로 나눠서 래스터 스레드에게 래스터화를 요청한다.
3. 래스터 스레드는 record를 바탕으로 각각의 타일들을 비트맵으로 만든다.
4. 컴포지터 스레드에서 비트맵들을 합성한다. (GPU에서 composite 과정이 처리될 수도 있다. - GraphicsLayer)
5. 화면에 출력한다.

https://tv.naver.com/v/4578425/list/279844
