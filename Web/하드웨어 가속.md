## 하드웨어 가속 (GPU 가속)

전통적으로 브라우저는 렌더링 과정을 대부분 CPU에 의존했다.
하지만 휴대용 기기에도 GPU가 기본으로 포함되고 비디오나 3D 그래픽과 같은 콘텐츠의 사용이 늘면서 GPU를 활용해 웹 페이지의 콘텐츠를 렌더링하는 방법이 나오게 되었다.

![image](https://user-images.githubusercontent.com/62097867/215348934-678eae62-1045-48cf-b8c2-a1c0782081de.png)

레이어 트리를 구축하는 과정에서 특정 조건을 만족하면 GraphicsLayer를 생성한다고 했다.
이를 단위로 래스터화 시킨 이미지를 GPU를 이용해 한 장의 이미지로 합성해서 화면에 출력하는 기술을 하드웨어 가속 또는 GPU 가속이라 한다.

GPU는 CPU에 비해서 그래픽 처리 속도가 빠르고 애니메이션에 대한 비용이 적어 렌더링을 최적화할 수 있다.

### Graphics Layer 생성 조건

- transform 3d, preserve-3d 등
- <video\>, 3d 또는 하드웨어 가속된 2d <canvas\> 요소
- animation, transition
- opacity
- css filter
- will-change
- 하드웨어 가속 플러그인 (ex. 플래시)

### 주의할 점

- 레이어를 분리하여 GPU의 비디오 메모리에 저장하게 되면 **추가적인 메모리 점유가 발생**한다.
- 메인 메모리에서 비디오 메모리로 전달하는 과정에서 시간이 소요된다.
- VRAM이 부족하다면 GPU가 정상적으로 처리하지 못하므로 기기 사양을 고려해야 한다.

![image](https://user-images.githubusercontent.com/62097867/215349371-26e1a510-b0c6-48a1-bd59-4e37b74085b6.png)

### will-change 속성

하드웨어 가속을 적용하고 싶을 때 `transform:translateZ(0)`을 지정해 요소를 Graphics layer로 만들 수 있다.
그러나 무조건 GPU에 이미지를 업로드하는 것은 메모리 점유로 인한 성능 저하를 불러올 수 있다.

여기서 `will-change` 속성을 사용할 수 있다.

`will-change` 속성은 즉각적으로 변경이 발생할 속성에 관해 브라우저에 힌트를 주는 것이다.
브라우저가 해당 변경을 위한 작업을 사전에 최적화해 실제 변경이 발생될 때 더 빠르게 업데이트할 수 있고 더 효율적인 방법으로 GPU에 레이어를 생성할 수 있다.

```css
/** ⚠️ 변경되지 않을 요소까지 미리 적용하게 될 경우 오히려 성능 저하가 발생할 수 있다. (Graphics layer의 메모리 점유) */
*,
*::before,
*::after {
  will-change: all;
}
```

```css
/** ❌ 이미 일어난 변화에 관한 최적화는 효과가 없다. 발생할(will) 시점에 속성을 지정해야 한다. */
.element:hover {
  will-change: transform;
  transition: transform 2s;
  transform: rotate(30deg) scale(1.5);
}

/** ⭕ hover시 설정하여 hover와 클릭이 일어나는 시간 차 동안 최적화되도록 한다.  */
.element {
  /* 스타일 선언 */
  transition: transform 1s ease-out;
}
.element:hover {
  will-change: transform;
}
.element:active {
  transform: rotateY(180deg);
}
```

```jsx
// ⚠️ 변경이 완료된 이후에는 속성을 제거한다.
// 클릭할 때 애니메이션을 재생할 엘리먼트를 선택합니다.
var el = document.getElementById("element");

// 엘리먼트에 마우스 커서가 올라가면 will-change를 설정합니다.
el.addEventListener("mouseenter", hintBrowser);
el.addEventListener("animationEnd", removeHint);

function hintBrowser() {
  // 애니메이션의 키프레임 블럭을 최적화할 수 있는 속성을 사용합니다.
  this.style.willChange = "transform, opacity";
}

function removeHint() {
  this.style.willChange = "auto";
}
```

https://dev.opera.com/articles/ko/css-will-change-property/

https://d2.naver.com/helloworld/2061385
